import React, { useState, useEffect } from 'react'
import { toast } from 'react-toastify'
import { getProductsApi, createProductApi, updateProductApi, deleteProductApi } from '../../utils/api'
import { useAuth } from '../../context/AuthContext'
import MetaData from '../Layouts/MetaData'
import Loader from '../Layouts/Loader'
import SideBar from './SideBar'

export default function ProductManagement() {
	const { token } = useAuth()
	const [products, setProducts] = useState([])
	const [loading, setLoading] = useState(true)
	const [showModal, setShowModal] = useState(false)
	const [editingProduct, setEditingProduct] = useState(null)
	const [formData, setFormData] = useState({
		name: '',
		description: '',
		price: '',
		originalPrice: '',
		category: '',
		brand: '',
		type: '',
		stock: ''
	})
	const [images, setImages] = useState([])
	const [previewImages, setPreviewImages] = useState([])

	useEffect(() => {
		fetchProducts()
	}, [])

	const fetchProducts = async () => {
		setLoading(true)
		try {
			const response = await getProductsApi({})
			if (response.products) {
				setProducts(response.products)
			} else if (Array.isArray(response)) {
				setProducts(response)
			}
		} catch (error) {
			toast.error(error?.message || 'Failed to load products')
		} finally {
			setLoading(false)
		}
	}

	const handleInputChange = (e) => {
		const { name, value } = e.target
		setFormData(prev => ({
			...prev,
			[name]: value
		}))
	}

	const handleImageChange = (e) => {
		const files = Array.from(e.target.files)
		setImages(files)
		
		const previews = files.map(file => URL.createObjectURL(file))
		setPreviewImages(previews)
	}

	const handleSubmit = async (e) => {
		e.preventDefault()
		
		if (!formData.name || !formData.description || !formData.price || 
			!formData.category || !formData.brand || !formData.type || !formData.stock) {
			toast.error('Please fill in all required fields')
			return
		}

		if (!token) {
			toast.error('Authentication required. Please login again.')
			return
		}

		try {
			if (editingProduct) {
				// Update product
				await updateProductApi({
					token,
					id: editingProduct._id || editingProduct.id,
					productData: formData,
					images: images.length > 0 ? images : undefined
				})
				toast.success('Product updated successfully')
			} else {
				// Create product
				console.log('Creating product with:', { formData, imagesCount: images.length, hasToken: !!token })
				await createProductApi({
					token,
					productData: formData,
					images
				})
				toast.success('Product created successfully')
			}
			
			setShowModal(false)
			resetForm()
			fetchProducts()
		} catch (error) {
			console.error('Product save error:', error)
			const errorMessage = error?.data?.message || error?.message || 'Failed to save product'
			toast.error(errorMessage)
		}
	}

	const handleEdit = (product) => {
		setEditingProduct(product)
		setFormData({
			name: product.name || '',
			description: product.description || '',
			price: product.price || '',
			originalPrice: product.originalPrice || '',
			category: product.category || '',
			brand: product.brand || '',
			type: product.type || '',
			stock: product.stock || ''
		})
		setPreviewImages(product.images?.map(img => img.url) || [])
		setImages([])
		setShowModal(true)
	}

	const handleDelete = async (productId) => {
		if (!window.confirm('Are you sure you want to delete this product?')) {
			return
		}

		try {
			await deleteProductApi({ token, id: productId })
			toast.success('Product deleted successfully')
			fetchProducts()
		} catch (error) {
			toast.error(error?.message || 'Failed to delete product')
		}
	}

	const resetForm = () => {
		setFormData({
			name: '',
			description: '',
			price: '',
			originalPrice: '',
			category: '',
			brand: '',
			type: '',
			stock: ''
		})
		setImages([])
		setPreviewImages([])
		setEditingProduct(null)
	}

	const openModal = () => {
		resetForm()
		setShowModal(true)
	}

	const closeModal = () => {
		setShowModal(false)
		resetForm()
	}

	if (loading) {
		return (
			<>
				<MetaData title="Product Management" />
				<Loader />
			</>
		)
	}

	return (
		<>
			<MetaData title="Product Management" />

			<div className="d-flex">
				{/* Sidebar */}
				<div className="col-md-3 col-lg-2 p-0">
					<SideBar />
				</div>

				{/* Main Content */}
				<div className="col-md-9 col-lg-10 p-0">
					<div className="container-fluid" style={{ minHeight: '100vh', paddingTop: '2rem', paddingBottom: '2rem', backgroundColor: '#f8f9fa' }}>
						<div className="d-flex justify-content-between align-items-center mb-4">
							<h2>Product Management</h2>
							<button className="btn btn-primary" onClick={openModal}>
								<i className="fa fa-plus mr-2"></i>Add New Product
							</button>
						</div>

						{/* Products Table */}
						<div className="card">
							<div className="card-body">
								<div className="table-responsive">
									<table className="table table-hover">
										<thead>
											<tr>
												<th>Image</th>
												<th>Name</th>
												<th>Category</th>
												<th>Brand</th>
												<th>Price</th>
												<th>Stock</th>
												<th>Actions</th>
											</tr>
										</thead>
										<tbody>
											{products.length === 0 ? (
												<tr>
													<td colSpan="7" className="text-center py-4">
														<p className="text-muted">No products found. Create your first product!</p>
													</td>
												</tr>
											) : (
												products.map(product => (
													<tr key={product._id || product.id}>
														<td>
															<img
																src={product.images && product.images[0]?.url ? product.images[0].url : 'https://via.placeholder.com/50'}
																alt={product.name}
																style={{ width: '50px', height: '50px', objectFit: 'cover', borderRadius: '5px' }}
															/>
														</td>
														<td>{product.name}</td>
														<td>{product.category}</td>
														<td>{product.brand}</td>
														<td>â‚±{typeof product.price === 'number' ? product.price.toFixed(2) : product.price}</td>
														<td>{product.stock}</td>
														<td>
															<button
																className="btn btn-sm btn-info mr-2"
																onClick={() => handleEdit(product)}
															>
																<i className="fa fa-edit"></i> Edit
															</button>
															<button
																className="btn btn-sm btn-danger"
																onClick={() => handleDelete(product._id || product.id)}
															>
																<i className="fa fa-trash"></i> Delete
															</button>
														</td>
													</tr>
												))
											)}
										</tbody>
									</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		{/* Product Modal */}
			{showModal && (
				<div className="modal show d-block" style={{ backgroundColor: 'rgba(0,0,0,0.5)' }} tabIndex="-1">
					<div className="modal-dialog modal-lg">
						<div className="modal-content">
							<div className="modal-header">
								<h5 className="modal-title">
									{editingProduct ? 'Edit Product' : 'Add New Product'}
								</h5>
								<button type="button" className="close" onClick={closeModal}>
									<span>&times;</span>
								</button>
							</div>
							<form onSubmit={handleSubmit}>
								<div className="modal-body">
									<div className="row">
										<div className="col-md-6 mb-3">
											<label>Product Name *</label>
											<input
												type="text"
												className="form-control"
												name="name"
												value={formData.name}
												onChange={handleInputChange}
												required
											/>
										</div>
										<div className="col-md-6 mb-3">
											<label>Category *</label>
											<select
												className="form-control"
												name="category"
												value={formData.category}
												onChange={handleInputChange}
												required
											>
												<option value="" disabled>Select Category</option>
												<option value="Cookware">Cookware</option>
												<option value="Cutlery">Cutlery</option>
												<option value="Baking Tools">Baking Tools</option>
												<option value="Storage">Storage</option>
												<option value="Appliances">Appliances</option>
												<option value="Accessories">Accessories</option>
											</select>
										</div>
										<div className="col-md-6 mb-3">
											<label>Brand *</label>
											<input
												type="text"
												className="form-control"
												name="brand"
												value={formData.brand}
												onChange={handleInputChange}
												required
											/>
										</div>
										<div className="col-md-6 mb-3">
											<label>Type *</label>
											<select
												className="form-control"
												name="type"
												value={formData.type}
												onChange={handleInputChange}
												required
											>
												<option value="" disabled>Select Type</option>
												<option value="Stainless Steel">Stainless Steel</option>
												<option value="Cast Iron">Cast Iron</option>
												<option value="Non-Stick">Non-Stick</option>
												<option value="Ceramic">Ceramic</option>
												<option value="Glass">Glass</option>
												<option value="Silicone">Silicone</option>
											</select>
										</div>
										<div className="col-md-6 mb-3">
											<label>Price *</label>
											<input
												type="number"
												step="0.01"
												className="form-control"
												name="price"
												value={formData.price}
												onChange={handleInputChange}
												required
											/>
										</div>
										<div className="col-md-6 mb-3">
											<label>Original Price (Optional)</label>
											<input
												type="number"
												step="0.01"
												className="form-control"
												name="originalPrice"
												value={formData.originalPrice}
												onChange={handleInputChange}
											/>
										</div>
										<div className="col-md-6 mb-3">
											<label>Stock *</label>
											<input
												type="number"
												className="form-control"
												name="stock"
												value={formData.stock}
												onChange={handleInputChange}
												required
											/>
										</div>
										<div className="col-12 mb-3">
											<label>Description *</label>
											<textarea
												className="form-control"
												rows="4"
												name="description"
												value={formData.description}
												onChange={handleInputChange}
												required
											></textarea>
										</div>
										<div className="col-12 mb-3">
											<label>Product Images</label>
											<input
												type="file"
												className="form-control"
												multiple
												accept="image/*"
												onChange={handleImageChange}
											/>
											{previewImages.length > 0 && (
												<div className="mt-3 d-flex flex-wrap gap-2">
													{previewImages.map((preview, index) => (
														<img
															key={index}
															src={preview}
															alt={`Preview ${index + 1}`}
															style={{ width: '100px', height: '100px', objectFit: 'cover', borderRadius: '5px' }}
														/>
													))}
												</div>
											)}
										</div>
									</div>
								</div>
								<div className="modal-footer">
									<button type="button" className="btn btn-secondary" onClick={closeModal}>
										Cancel
									</button>
									<button type="submit" className="btn btn-primary">
										{editingProduct ? 'Update Product' : 'Create Product'}
									</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			)}
		</>
	)
}
