import { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react'
import { toast } from 'react-toastify'
import { meApi } from '../utils/api'

const AuthContext = createContext(null)

const TOKEN_KEY = 'auth_token'
const USER_KEY = 'auth_user'

export function AuthProvider({ children }) {
	const [token, setToken] = useState(null)
	const [user, setUser] = useState(null) // { id, email, role, emailVerified, avatar, phone, address, zipCode, gender, dateOfBirth }
	const [loading, setLoading] = useState(true)

	useEffect(() => {
		const savedToken = localStorage.getItem(TOKEN_KEY)
		const savedUser = localStorage.getItem(USER_KEY)
		if (savedToken) setToken(savedToken)
		if (savedUser) {
			try { setUser(JSON.parse(savedUser)) } catch {}
		}
		setLoading(false)
	}, [])

	const login = useCallback((jwtToken, userInfo) => {
		setToken(jwtToken)
		setUser(userInfo)
		localStorage.setItem(TOKEN_KEY, jwtToken)
		localStorage.setItem(USER_KEY, JSON.stringify(userInfo))
	}, [])

	const logout = useCallback(() => {
		setToken(null)
		setUser(null)
		localStorage.removeItem(TOKEN_KEY)
		localStorage.removeItem(USER_KEY)
	}, [])

	const refreshUser = useCallback(async () => {
		if (!token) return
		try {
			const response = await meApi({ token })
			if (response.success && response.user) {
				const updatedUser = response.user
				setUser(updatedUser)
				localStorage.setItem(USER_KEY, JSON.stringify(updatedUser))
				
				// If user was deactivated, show notification and log them out
				if (updatedUser.isActive === false) {
					toast.error('Your account has been deactivated by an administrator.')
					setTimeout(() => {
						setToken(null)
						setUser(null)
						localStorage.removeItem(TOKEN_KEY)
						localStorage.removeItem(USER_KEY)
					}, 2000) // Give time for toast to show
				}
			}
		} catch (error) {
			console.error('Error refreshing user data:', error)
			// If API call fails (e.g., token invalid), log out
			if (error.status === 401 || error.status === 403) {
				setToken(null)
				setUser(null)
				localStorage.removeItem(TOKEN_KEY)
				localStorage.removeItem(USER_KEY)
			}
		}
	}, [token])

	// Periodically check user status to handle real-time deactivation
	// Temporarily disabled to avoid initialization issues
	// useEffect(() => {
	// 	if (!token || !user) return

	// 	// Check user status every 30 seconds
	// 	const interval = setInterval(() => {
	// 		refreshUser()
	// 	}, 30000)

	// 	return () => clearInterval(interval)
	// }, [token, user, refreshUser])

	const value = useMemo(() => ({ 
		token, 
		user, 
		loading, 
		isAuthenticated: Boolean(token && user && user.isActive !== false), 
		login, 
		logout, 
		refreshUser 
	}), [token, user, loading, login, logout, refreshUser])

	return (
		<AuthContext.Provider value={value}>
			{children}
		</AuthContext.Provider>
	)
}

export function useAuth() {
	const ctx = useContext(AuthContext)
	if (!ctx) throw new Error('useAuth must be used within AuthProvider')
	return ctx
}
